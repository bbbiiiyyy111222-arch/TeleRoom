<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TeleRoom ‚Äî —Ç–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</title>
    <style>
        /* ========== –°–ë–†–û–° –ò –®–†–ò–§–¢–´ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: radial-gradient(circle at 20% 30%, #1a1b2f, #0c0d1a);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 12px;
        }

        #app {
            width: 100%;
            max-width: 480px;
            height: 90vh;
            background: rgba(20, 22, 36, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 36px;
            box-shadow: 0 25px 50px -8px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            color: #fff;
        }

        /* ========== –õ–û–ì–ò–ù ========== */
        #login-screen {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 28px;
            background: radial-gradient(circle at 30% 40%, #2c2e4a, #1a1c2c);
            color: white;
        }

        .logo {
            font-size: 96px;
            margin-bottom: 8px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }

        .app-title {
            font-size: 44px;
            font-weight: 800;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #b794f4, #a0a8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .app-subtitle {
            font-size: 15px;
            margin-bottom: 48px;
            opacity: 0.7;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .login-input {
            width: 100%;
            padding: 18px 24px;
            margin-bottom: 16px;
            border: none;
            border-radius: 40px;
            font-size: 16px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            transition: 0.25s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #a0a8ff;
            background: rgba(0,0,0,0.5);
            transform: scale(1.02);
        }

        .login-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 40px;
            background: linear-gradient(145deg, #5f6cff, #3f4ad0);
            color: white;
            font-size: 18px;
            font-weight: 700;
            margin-top: 20px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 12px 30px -8px #3f4ad080;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 35px -6px #3f4ad0c0;
        }

        #username-error {
            color: #ff8a8a;
            margin-top: 8px;
            font-size: 14px;
            display: none;
            background: rgba(255,80,80,0.15);
            padding: 10px 18px;
            border-radius: 60px;
            backdrop-filter: blur(4px);
        }

        /* ========== –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° ========== */
        #main-screen {
            height: 100%;
            display: none;
            flex-direction: column;
            background: #0f1016;
        }

        .header {
            background: rgba(18, 20, 28, 0.9);
            backdrop-filter: blur(16px);
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.2s;
            padding: 6px 12px 6px 6px;
            border-radius: 40px;
            background: rgba(255,255,255,0.03);
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(145deg, #5f6cff, #3b45b0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            border: 2px solid rgba(255,255,255,0.25);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            color: white;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
            color: white;
            font-size: 22px;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.12);
            transform: scale(1.05);
        }

        .tabs {
            display: flex;
            background: #0c0d12;
            padding: 10px 12px;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .tab {
            flex: 1;
            padding: 12px 6px;
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: 600;
            color: #9498a5;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.2s;
        }

        .tab.active {
            background: linear-gradient(145deg, #2c2f42, #1f212f);
            color: white;
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.05);
        }

        #chats-list, #groups-list, #contacts-list, #profile-screen, #edit-profile-screen {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: none;
            background: #0f1016;
        }

        .active-list {
            display: block !important;
        }

        .search-container {
            padding: 8px 4px 16px 4px;
            background: transparent;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 40px;
            font-size: 15px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.06);
            color: white;
            transition: 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #6f7cff;
            background: rgba(20,20,40,0.6);
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px;
            background: rgba(20, 22, 32, 0.7);
            backdrop-filter: blur(6px);
            border-radius: 24px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.03);
            cursor: pointer;
            transition: 0.2s ease;
        }

        .chat-item:hover {
            background: rgba(35, 38, 52, 0.9);
            transform: translateX(6px);
            border-color: rgba(160, 168, 255, 0.3);
        }

        .chat-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(145deg, #4f5bdb, #323ca0);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 26px;
            font-weight: 600;
            box-shadow: 0 8px 18px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.15);
        }

        .chat-info {
            flex: 1;
        }

        .chat-name {
            font-weight: 700;
            font-size: 17px;
            margin-bottom: 5px;
            color: white;
        }

        .chat-last-message {
            font-size: 14px;
            color: #a6a9b6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .chat-badge {
            background: #5f6cff;
            color: white;
            border-radius: 40px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 10px #3f4ad080;
        }

        .online-status { color: #64e6b0; font-size: 13px; }
        .offline-status { color: #8f94a2; font-size: 13px; }

        #chat-screen {
            height: 100%;
            display: none;
            flex-direction: column;
            background: #0c0d12;
        }

        .chat-header {
            background: rgba(18, 20, 28, 0.95);
            backdrop-filter: blur(16px);
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .back-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.06);
            color: white;
            font-size: 24px;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-title {
            font-weight: 700;
            font-size: 18px;
            color: white;
        }

        .chat-header-status {
            font-size: 12px;
            opacity: 0.7;
            color: #b8bccb;
        }

        #messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: radial-gradient(circle at 50% 0%, #11131c, #0a0b10);
        }

        .message {
            max-width: 80%;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.25s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .my-message { align-self: flex-end; }
        .other-message { align-self: flex-start; }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 24px;
            word-break: break-word;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .my-message .message-bubble {
            background: linear-gradient(145deg, #5f6cff, #4552d9);
            color: white;
            border-bottom-right-radius: 6px;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .other-message .message-bubble {
            background: rgba(30, 33, 48, 0.8);
            backdrop-filter: blur(10px);
            color: white;
            border-bottom-left-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .message-sender {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #a7b0ff;
        }

        .message-time {
            font-size: 10px;
            margin-top: 6px;
            opacity: 0.65;
            align-self: flex-end;
        }

        .message-input-area {
            background: rgba(18, 20, 28, 0.9);
            backdrop-filter: blur(20px);
            padding: 14px 18px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .attach-btn, .voice-record-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(6px);
            color: #cfd4ff;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .voice-record-btn.recording {
            background: #ff4d6d;
            color: white;
            animation: pulse 1.2s infinite;
        }

        #message-input {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 40px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.05);
            color: white;
            font-size: 15px;
        }

        #message-input:focus {
            outline: none;
            border-color: #5f6cff;
            background: rgba(20,20,40,0.7);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(145deg, #5f6cff, #3f4ad0);
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 6px 14px #3f4ad080;
        }

        /* ========== –ü–†–û–§–ò–õ–¨ (–ü–†–û–°–ú–û–¢–†) ========== */
        #profile-screen {
            background: #0f1016;
            padding: 0;
            display: none;
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 36px 24px;
            background: radial-gradient(circle at 30% 20%, #252842, #13141c);
            border-bottom-left-radius: 32px;
            border-bottom-right-radius: 32px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .profile-avatar {
            width: 110px;
            height: 110px;
            background: linear-gradient(145deg, #5f6cff, #323ca0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 52px;
            font-weight: 600;
            border: 4px solid rgba(255,255,255,0.25);
            box-shadow: 0 18px 30px -8px black;
            margin-bottom: 18px;
            color: white;
        }

        .profile-name {
            font-size: 28px;
            font-weight: 800;
            color: white;
            margin-bottom: 6px;
        }

        .profile-bio {
            font-size: 15px;
            opacity: 0.8;
            max-width: 80%;
            text-align: center;
            color: #cacfe0;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            padding: 22px 16px;
            background: rgba(0,0,0,0.2);
            margin: 20px 16px;
            border-radius: 40px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.03);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: #b0b8ff;
        }

        .stat-label {
            font-size: 12px;
            color: #9ea2b0;
            margin-top: 6px;
        }

        .profile-actions {
            padding: 8px 20px 30px;
        }

        .profile-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .profile-btn-primary {
            background: linear-gradient(145deg, #5f6cff, #414dcf);
            color: white;
            box-shadow: 0 10px 22px #3f4ad080;
        }

        .profile-btn-secondary {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(8px);
            color: white;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .profile-btn-edit {
            background: linear-gradient(145deg, #4CAF50, #2E7D32);
            color: white;
            box-shadow: 0 10px 22px rgba(46, 125, 50, 0.3);
        }

        /* ========== –≠–ö–†–ê–ù –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–†–û–§–ò–õ–Ø ========== */
        #edit-profile-screen {
            background: #0f1016;
            padding: 20px;
            display: none;
        }

        .edit-profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 24px;
        }

        .edit-profile-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .edit-profile-avatar {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .edit-avatar-image {
            width: 120px;
            height: 120px;
            background: linear-gradient(145deg, #5f6cff, #323ca0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 56px;
            font-weight: 600;
            border: 4px solid rgba(255,255,255,0.25);
            box-shadow: 0 18px 30px -8px black;
            margin-bottom: 16px;
            color: white;
            cursor: pointer;
            transition: 0.2s;
        }

        .edit-avatar-image:hover {
            transform: scale(1.05);
            border-color: #5f6cff;
        }

        .avatar-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .avatar-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            color: white;
            transition: 0.2s;
        }

        .avatar-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .avatar-btn-danger {
            background: rgba(255, 80, 80, 0.2);
            color: #ff8a8a;
        }

        .avatar-btn-danger:hover {
            background: rgba(255, 80, 80, 0.3);
        }

        .edit-field {
            margin-bottom: 24px;
        }

        .edit-label {
            font-size: 14px;
            color: #a6a9b6;
            margin-bottom: 8px;
            display: block;
        }

        .edit-input {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            transition: 0.2s;
        }

        .edit-input:focus {
            outline: none;
            border-color: #5f6cff;
            background: rgba(0,0,0,0.5);
        }

        .edit-textarea {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            resize: vertical;
            min-height: 100px;
        }

        .edit-buttons {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .save-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(145deg, #5f6cff, #3f4ad0);
            color: white;
            box-shadow: 0 10px 22px #3f4ad080;
        }

        .cancel-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            background: rgba(255,255,255,0.05);
            color: white;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(25, 28, 40, 0.9);
            backdrop-filter: blur(30px);
            width: 90%;
            max-width: 380px;
            border-radius: 36px;
            padding: 28px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            color: white;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 26px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .typing-indicator {
            padding: 8px 16px;
            color: #a7b0ff;
            font-size: 13px;
            font-style: italic;
            background: rgba(80, 90, 200, 0.15);
            border-radius: 40px;
            align-self: flex-start;
            backdrop-filter: blur(4px);
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #8f94a2;
            font-size: 16px;
        }

        .image-viewer {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .image-viewer.active { display: flex; }
        .image-viewer img { max-width: 90%; max-height: 80%; border-radius: 20px; }
        .close-viewer {
            position: absolute; top: 24px; right: 24px;
            color: white; font-size: 44px;
            cursor: pointer;
            width: 56px; height: 56px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.4); border-radius: 50%;
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- –õ–û–ì–ò–ù -->
        <div id="login-screen">
            <div class="logo">üì±</div>
            <div class="app-title">TeleRoom</div>
            <div class="app-subtitle">—Ç–≤–æ—è –≤—Å–µ–ª–µ–Ω–Ω–∞—è</div>
            <input type="text" id="login-name" class="login-input" placeholder="–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º" value="" onkeyup="checkUsername()" autofocus>
            <div id="username-error"></div>
            <button class="login-btn" onclick="register()">üöÄ –í–æ–π—Ç–∏ –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</button>
        </div>

        <!-- –û–°–ù–û–í–ù–û–ô -->
        <div id="main-screen">
            <div class="header">
                <div class="user-info" onclick="showProfile()">
                    <div class="user-avatar" id="header-avatar">üë§</div>
                    <span class="user-name" id="header-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="showCreateGroupModal()">‚ûï</button>
                    <button class="header-btn" onclick="logout()">üö™</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('chats', this)">üí¨ –ß–∞—Ç—ã</button>
                <button class="tab" onclick="switchTab('groups', this)">üë• –ì—Ä—É–ø–ø—ã</button>
                <button class="tab" onclick="switchTab('contacts', this)">üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
            </div>

            <div id="chats-list" class="active-list">
                <div class="search-container">
                    <input type="text" id="chat-search" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤..." onkeyup="searchChats()">
                </div>
                <div id="chats-container"></div>
            </div>
            
            <div id="groups-list">
                <div id="groups-container"></div>
            </div>
            
            <div id="contacts-list">
                <div class="search-container">
                    <input type="text" id="contact-search" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." onkeyup="searchContacts()">
                </div>
                <div id="contacts-container"></div>
            </div>

            <!-- –ü–†–û–§–ò–õ–¨ (–ü–†–û–°–ú–û–¢–†) - –ó–î–ï–°–¨ –ï–°–¢–¨ –ö–ù–û–ü–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø! -->
            <div id="profile-screen">
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar">üë§</div>
                    <div class="profile-name" id="profile-name"></div>
                    <div class="profile-bio" id="profile-bio"></div>
                    <div style="font-size: 14px; opacity: 0.7; margin-top: 8px;" id="profile-username"></div>
                </div>
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="profile-groups">0</div>
                        <div class="stat-label">–ì—Ä—É–ø–ø</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="profile-chats">0</div>
                        <div class="stat-label">–ß–∞—Ç–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="profile-joined">0</div>
                        <div class="stat-label">–î–Ω–µ–π</div>
                    </div>
                </div>
                <div class="profile-actions">
                    <!-- –ö–ù–û–ü–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–†–û–§–ò–õ–Ø - –ó–ï–õ–ï–ù–ê–Ø! -->
                    <button class="profile-btn profile-btn-edit" onclick="showEditProfile()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                    <button class="profile-btn profile-btn-secondary" onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
                </div>
            </div>

            <!-- –≠–ö–†–ê–ù –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–†–û–§–ò–õ–Ø -->
            <div id="edit-profile-screen">
                <div class="edit-profile-header">
                    <button class="back-btn" onclick="backToProfile()">‚Üê</button>
                    <div class="edit-profile-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                </div>

                <div class="edit-profile-avatar">
                    <div class="edit-avatar-image" id="edit-avatar" onclick="changeAvatar()">üë§</div>
                    <div class="avatar-actions">
                        <button class="avatar-btn" onclick="changeAvatar()">üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                        <button class="avatar-btn avatar-btn-danger" onclick="removeAvatar()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>

                <div class="edit-field">
                    <label class="edit-label">üë§ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="edit-name" class="edit-input" placeholder="–¢–≤–æ–µ –∏–º—è">
                </div>

                <div class="edit-field">
                    <label class="edit-label">@ –Æ–∑–µ—Ä–Ω–µ–π–º</label>
                    <input type="text" id="edit-username" class="edit-input" placeholder="—É–Ω–∏–∫–∞–ª—å–Ω—ã–π —é–∑–µ—Ä–Ω–µ–π–º">
                </div>

                <div class="edit-field">
                    <label class="edit-label">üìù –û —Å–µ–±–µ</label>
                    <textarea id="edit-bio" class="edit-textarea" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..."></textarea>
                </div>

                <div class="edit-buttons">
                    <button class="cancel-btn" onclick="backToProfile()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="save-btn" onclick="saveProfileChanges()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –ß–ê–¢ -->
        <div id="chat-screen">
            <div class="chat-header">
                <button class="back-btn" onclick="closeChat()">‚Üê</button>
                <div class="chat-header-info">
                    <div class="chat-header-title" id="chat-title">...</div>
                    <div class="chat-header-status" id="chat-status">...</div>
                </div>
            </div>
            <div id="messages-container"></div>
            <div class="message-input-area">
                <div style="position: relative;">
                    <button class="attach-btn" onclick="toggleAttachMenu()">üìé</button>
                    <div class="attach-menu" id="attachMenu" style="position: absolute; bottom: 60px; left: 0; background: rgba(20,22,36,0.95); backdrop-filter: blur(20px); border-radius: 24px; padding: 8px; display: none; border: 1px solid rgba(255,255,255,0.06);">
                        <button class="attach-menu-item" onclick="selectPhoto()" style="display: block; padding: 12px 24px; background: none; border: none; color: white; font-size: 16px;">üì∑ –§–æ—Ç–æ</button>
                        <button class="attach-menu-item" onclick="selectFile()" style="display: block; padding: 12px 24px; background: none; border: none; color: white; font-size: 16px;">üìé –§–∞–π–ª</button>
                    </div>
                </div>
                <button class="voice-record-btn" id="voiceRecordBtn" onclick="toggleVoiceRecording()">üé§</button>
                <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="onMessageKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–ö–ò -->
        <div id="create-group-modal" class="modal">
            <div class="modal-content">
                <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</div>
                <input type="text" id="group-name" class="modal-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                <input type="text" id="group-description" class="modal-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑.)">
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" onclick="hideCreateGroupModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="modal-btn modal-btn-primary" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="edit-bio-modal" class="modal">
            <div class="modal-content">
                <div class="modal-title">–û —Å–µ–±–µ</div>
                <textarea id="bio-text" class="modal-input" style="height: 120px; resize: none;" placeholder="–†–∞—Å—Å–∫–∞–∂–∏..."></textarea>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" onclick="hideEditBioModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="modal-btn modal-btn-primary" onclick="saveBio()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="imageViewer" class="image-viewer" onclick="closeImageViewer()">
            <span class="close-viewer">√ó</span>
            <img id="viewerImage" src="">
        </div>
    </div>

    <input type="file" id="photoInput" accept="image/*" style="display: none">
    <input type="file" id="fileInput" style="display: none">
    <input type="file" id="avatarInput" accept="image/*" style="display: none">

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        const socket = io();
        let currentUser = null;
        let currentChat = null;
        let currentChatType = 'group';
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let groups = [];
        let privateChats = [];
        let allUsers = [];
        let audioElements = {};

        // ========== –ü–†–û–í–ï–†–ö–ê –ò–ú–ï–ù–ò ==========
        let usernameCheckTimeout;
        function checkUsername() {
            clearTimeout(usernameCheckTimeout);
            const name = document.getElementById('login-name').value.trim();
            const errorDiv = document.getElementById('username-error');
            
            if (name.length < 2) {
                errorDiv.style.display = 'none';
                return;
            }
            
            usernameCheckTimeout = setTimeout(() => {
                fetch(`/api/check-username/${encodeURIComponent(name)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data.available) {
                            const savedName = localStorage.getItem('teleRoomName');
                            if (savedName !== name) {
                                errorDiv.style.display = 'block';
                                errorDiv.innerHTML = '‚ùå –≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ! –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ.';
                            } else {
                                errorDiv.style.display = 'none';
                            }
                        } else {
                            errorDiv.style.display = 'none';
                        }
                    });
            }, 500);
        }

        // ========== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ==========
        function register() {
            const name = document.getElementById('login-name').value.trim();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
                return;
            }
            
            console.log('üöÄ –ù–ê–ñ–ê–¢–ê –ö–ù–û–ü–ö–ê –í–•–û–î–ê –î–õ–Ø:', name);
            
            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            
            localStorage.setItem('teleRoomId', userId);
            localStorage.setItem('teleRoomName', name);
            
            socket.emit('register', { name, phone: userId });
            
            // –ú–ì–ù–û–í–ï–ù–ù–û–ï –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï
            currentUser = {
                id: Date.now(),
                name: name,
                phone: userId,
                avatar: null,
                bio: '',
                created_at: new Date().toISOString()
            };
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
            document.getElementById('header-name').innerText = name;
            document.getElementById('header-avatar').innerText = name[0].toUpperCase();
            
            loadGroups();
            loadPrivateChats();
            loadAllUsers();
        }

        // ========== –°–û–ö–ï–¢ –°–û–ë–´–¢–ò–Ø ==========
        socket.on('register_error', (error) => {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
            alert(error);
            document.getElementById('username-error').style.display = 'block';
            document.getElementById('username-error').innerHTML = '‚ùå ' + error;
        });

        socket.on('registered', (user) => {
            console.log('‚úÖ –ü–û–õ–£–ß–ï–ù –û–¢–í–ï–¢ –û–¢ –°–ï–†–í–ï–†–ê:', user);
            currentUser = user;
            document.getElementById('header-name').innerText = user.name;
            document.getElementById('header-avatar').innerText = user.name[0].toUpperCase();
        });

        // ========== –ê–í–¢–û–í–•–û–î ==========
        (function autoLogin() {
            const savedName = localStorage.getItem('teleRoomName');
            
            if (savedName) {
                document.getElementById('login-name').value = savedName;
                
                currentUser = {
                    id: Date.now(),
                    name: savedName,
                    phone: localStorage.getItem('teleRoomId') || 'user_' + Date.now(),
                    avatar: null,
                    bio: '',
                    created_at: new Date().toISOString()
                };
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-screen').style.display = 'flex';
                document.getElementById('header-name').innerText = savedName;
                document.getElementById('header-avatar').innerText = savedName[0].toUpperCase();
                
                loadGroups();
                loadPrivateChats();
                loadAllUsers();
            }
        })();

        // ========== –ü–†–û–§–ò–õ–¨ (–ü–†–û–°–ú–û–¢–†) ==========
        function showProfile() {
            if (!currentUser) return;
            
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('profile-screen').style.display = 'block';
            
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-username').innerText = '@' + (currentUser.phone || 'username');
            document.getElementById('profile-bio').innerText = currentUser.bio || '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏';
            
            if (currentUser.avatar) {
                document.getElementById('profile-avatar').innerHTML = `<img src="/avatars/${currentUser.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                document.getElementById('header-avatar').innerHTML = `<img src="/avatars/${currentUser.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            } else {
                document.getElementById('profile-avatar').innerText = currentUser.name[0].toUpperCase();
                document.getElementById('header-avatar').innerText = currentUser.name[0].toUpperCase();
            }
            
            document.getElementById('profile-groups').innerText = groups.length;
            document.getElementById('profile-chats').innerText = privateChats.length;
            const days = Math.floor((Date.now() - new Date(currentUser.created_at || Date.now())) / (1000*60*60*24)) || 1;
            document.getElementById('profile-joined').innerText = days;
        }

        function backToMain() {
            document.getElementById('profile-screen').style.display = 'none';
            document.getElementById('edit-profile-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
        }

        // ========== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–§–ò–õ–Ø ==========
        function showEditProfile() {
            if (!currentUser) return;
            
            document.getElementById('profile-screen').style.display = 'none';
            document.getElementById('edit-profile-screen').style.display = 'block';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            document.getElementById('edit-name').value = currentUser.name || '';
            document.getElementById('edit-username').value = currentUser.phone || '';
            document.getElementById('edit-bio').value = currentUser.bio || '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
            if (currentUser.avatar) {
                document.getElementById('edit-avatar').innerHTML = `<img src="/avatars/${currentUser.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            } else {
                document.getElementById('edit-avatar').innerText = currentUser.name[0].toUpperCase();
            }
        }

        function backToProfile() {
            document.getElementById('edit-profile-screen').style.display = 'none';
            document.getElementById('profile-screen').style.display = 'block';
            showProfile(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
        }

        function saveProfileChanges() {
            const newName = document.getElementById('edit-name').value.trim();
            const newUsername = document.getElementById('edit-username').value.trim();
            const newBio = document.getElementById('edit-bio').value.trim();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è
            if (newName && newName !== currentUser.name) {
                fetch('/api/user/update-name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, newName: newName })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        currentUser.name = data.name;
                        localStorage.setItem('teleRoomName', data.name);
                    }
                });
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —é–∑–µ—Ä–Ω–µ–π–º
            if (newUsername && newUsername !== currentUser.phone) {
                fetch('/api/user/update-username', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, newUsername: newUsername })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        currentUser.phone = data.username;
                        localStorage.setItem('teleRoomId', data.username);
                    }
                });
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∏–æ
            if (newBio !== currentUser.bio) {
                fetch('/api/users/update-bio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, bio: newBio })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        currentUser.bio = newBio;
                    }
                });
            }
            
            alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
            backToProfile();
        }

        // ========== –ê–í–ê–¢–ê–†–ö–ê ==========
        function changeAvatar() {
            document.getElementById('avatarInput').click();
        }

        function removeAvatar() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É?')) {
                fetch('/api/user/remove-avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        currentUser.avatar = null;
                        document.getElementById('edit-avatar').innerText = currentUser.name[0].toUpperCase();
                        document.getElementById('profile-avatar').innerText = currentUser.name[0].toUpperCase();
                        document.getElementById('header-avatar').innerText = currentUser.name[0].toUpperCase();
                        alert('‚úÖ –ê–≤–∞—Ç–∞—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                    }
                });
            }
        }

        document.getElementById('avatarInput').onchange = function(e) {
            const file = e.target.files[0];
            if (file && currentUser) {
                const formData = new FormData();
                formData.append('avatar', file);
                formData.append('userId', currentUser.id);
                fetch('/api/user/upload-avatar', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        currentUser.avatar = data.avatar;
                        const avatarHtml = `<img src="/avatars/${data.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        document.getElementById('edit-avatar').innerHTML = avatarHtml;
                        document.getElementById('profile-avatar').innerHTML = avatarHtml;
                        document.getElementById('header-avatar').innerHTML = avatarHtml;
                        alert('‚úÖ –ê–≤–∞—Ç–∞—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                    }
                });
            }
        };

        // ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ==========
        function loadGroups() {
            if (!currentUser) return;
            fetch(`/api/groups/${currentUser.id}`)
                .then(res => res.json())
                .then(data => {
                    groups = data;
                    renderGroupsList();
                    renderChatsList();
                })
                .catch(() => {
                    groups = [];
                    renderGroupsList();
                    renderChatsList();
                });
        }

        function loadPrivateChats() {
            if (!currentUser) return;
            fetch(`/api/private_chats/${currentUser.id}`)
                .then(res => res.json())
                .then(data => {
                    privateChats = data;
                    renderChatsList();
                })
                .catch(() => {
                    privateChats = [];
                    renderChatsList();
                });
        }

        function loadAllUsers() {
            fetch('/api/users')
                .then(res => res.json())
                .then(users => {
                    allUsers = users;
                    renderContactsList(users);
                })
                .catch(() => {
                    allUsers = [];
                    renderContactsList([]);
                });
        }

        // ========== –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        socket.on('user_groups', (data) => { groups = data; renderGroupsList(); renderChatsList(); });
        socket.on('user_private_chats', (data) => { privateChats = data; renderChatsList(); });
        socket.on('all_users', (users) => { allUsers = users; renderContactsList(users); });
        socket.on('user_online', (userId) => { if (allUsers) { allUsers = allUsers.map(u => { if (u.id === userId) u.online = 1; return u; }); renderContactsList(allUsers); } });
        socket.on('user_offline', (userId) => { if (allUsers) { allUsers = allUsers.map(u => { if (u.id === userId) u.online = 0; return u; }); renderContactsList(allUsers); } });
        socket.on('new_message', (message) => { if (currentChat && message.chat_id === currentChat.id) { renderMessage(message); document.getElementById('messages-container').scrollTop = document.getElementById('messages-container').scrollHeight; } if (message.chat_type === 'private') loadPrivateChats(); else loadGroups(); });
        socket.on('user_typing', (data) => { const container = document.getElementById('messages-container'); if (!container) return; let typingDiv = document.getElementById('typingIndicator'); if (!typingDiv) { typingDiv = document.createElement('div'); typingDiv.id = 'typingIndicator'; typingDiv.className = 'typing-indicator'; container.appendChild(typingDiv); } typingDiv.innerHTML = `${data.user_name} –ø–µ—á–∞—Ç–∞–µ—Ç...`; setTimeout(() => { const div = document.getElementById('typingIndicator'); if (div) div.remove(); }, 3000); });

        // ========== –ü–û–ò–°–ö ==========
        function searchContacts() {
            const query = document.getElementById('contact-search').value.toLowerCase().trim();
            if (!allUsers || allUsers.length === 0) return;
            let filtered = query === '' ? allUsers.filter(u => u.id !== currentUser?.id) : allUsers.filter(u => u.id !== currentUser?.id && u.name && u.name.toLowerCase().includes(query));
            renderContactsList(filtered);
        }

        function searchChats() {
            const query = document.getElementById('chat-search').value.toLowerCase().trim();
            renderChatsList(query);
        }

        // ========== –û–¢–†–ò–°–û–í–ö–ê ==========
        function renderGroupsList() {
            const container = document.getElementById('groups-container');
            if (!container) return;
            container.innerHTML = '';
            if (groups.length === 0) { container.innerHTML = '<div class="no-results">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø<br><br>–ù–∞–∂–º–∏—Ç–µ ‚ûï —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å</div>'; return; }
            groups.forEach(group => { container.innerHTML += `<div class="chat-item" onclick="openGroupChat(${group.id}, '${group.name.replace(/'/g, "\\'")}')"><div class="chat-avatar">üë•</div><div class="chat-info"><div class="chat-name">${group.name}</div><div class="chat-last-message">${group.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div></div><div class="chat-badge">${group.members_count || 0}</div></div>`; });
        }

        function renderChatsList(query = '') {
            const container = document.getElementById('chats-container');
            if (!container) return;
            container.innerHTML = '';
            const allChats = [...privateChats.map(pc => ({ id: pc.id, type: 'private', name: pc.other_user_name, last_message: pc.last_message, last_time: pc.last_time, online: pc.online })), ...groups.map(g => ({ id: g.id, type: 'group', name: g.name, last_message: g.last_message, last_time: g.last_time, members_count: g.members_count }))].sort((a, b) => new Date(b.last_time || 0) - new Date(a.last_time || 0));
            const filtered = query ? allChats.filter(c => c.name && c.name.toLowerCase().includes(query.toLowerCase())) : allChats;
            if (filtered.length === 0) { container.innerHTML = '<div class="no-results">–ß–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
            filtered.forEach(chat => { if (chat.type === 'private') { container.innerHTML += `<div class="chat-item" onclick="openPrivateChat(${chat.id}, '${chat.name.replace(/'/g, "\\'")}')"><div class="chat-avatar">üë§</div><div class="chat-info"><div class="chat-name">${chat.name}</div><div class="chat-last-message">${chat.last_message || '–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ'}</div></div><div class="${chat.online ? 'online-status' : 'offline-status'}">${chat.online ? 'üü¢' : '‚ö™'}</div></div>`; } else { container.innerHTML += `<div class="chat-item" onclick="openGroupChat(${chat.id}, '${chat.name.replace(/'/g, "\\'")}')"><div class="chat-avatar">üë•</div><div class="chat-info"><div class="chat-name">${chat.name}</div><div class="chat-last-message">${chat.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div></div><div class="chat-badge">${chat.members_count || 0}</div></div>`; } });
        }

        function renderContactsList(users) {
            const container = document.getElementById('contacts-container');
            if (!container) return;
            container.innerHTML = '';
            if (!users || users.length === 0) { container.innerHTML = '<div class="no-results">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
            users.forEach(user => { const userName = user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'; const isOnline = user.online === 1; container.innerHTML += `<div class="chat-item" onclick="startPrivateChat(${user.id}, '${userName.replace(/'/g, "\\'")}')"><div class="chat-avatar">üë§</div><div class="chat-info"><div class="chat-name">${userName}</div><div class="chat-last-message">${user.bio || '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'}</div></div><div class="${isOnline ? 'online-status' : 'offline-status'}">${isOnline ? 'üü¢ –æ–Ω–ª–∞–π–Ω' : '‚ö™ –æ—Ñ–ª–∞–π–Ω'}</div></div>`; });
        }

        // ========== –ì–†–£–ü–ü–´ ==========
        function showCreateGroupModal() { document.getElementById('create-group-modal').classList.add('active'); }
        function hideCreateGroupModal() { document.getElementById('create-group-modal').classList.remove('active'); document.getElementById('group-name').value = ''; document.getElementById('group-description').value = ''; }
        function createGroup() {
            const name = document.getElementById('group-name').value.trim();
            const description = document.getElementById('group-description').value.trim();
            if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã'); return; }
            fetch('/api/groups', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, description, userId: currentUser.id }) })
                .then(res => res.json()).then(group => { hideCreateGroupModal(); loadGroups(); });
        }

        // ========== –õ–ò–ß–ù–´–ï –ß–ê–¢–´ ==========
        function startPrivateChat(otherUserId, otherUserName) {
            fetch('/api/private_chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user1_id: currentUser.id, user2_id: otherUserId }) })
                .then(res => res.json()).then(data => { openPrivateChat(data.chat_id, otherUserId, otherUserName); });
        }
        function openPrivateChat(chatId, otherUserId, otherUserName) {
            currentChatType = 'private'; currentChat = { id: chatId, name: otherUserName, otherUserId: otherUserId };
            document.getElementById('main-screen').style.display = 'none'; document.getElementById('chat-screen').style.display = 'flex'; document.getElementById('chat-title').innerText = otherUserName;
            socket.emit('join_private_chat', chatId); loadPrivateMessages(chatId);
            const user = allUsers.find(u => u.id === otherUserId); const status = user?.online ? 'üü¢ –æ–Ω–ª–∞–π–Ω' : '‚ö™ –æ—Ñ–ª–∞–π–Ω'; document.getElementById('chat-status').innerText = status;
        }
        function loadPrivateMessages(chatId) {
            fetch(`/api/messages/private/${chatId}`).then(res => res.json()).then(messages => { const container = document.getElementById('messages-container'); container.innerHTML = ''; messages.forEach(msg => renderMessage(msg)); container.scrollTop = container.scrollHeight; });
        }

        // ========== –ì–†–£–ü–ü–û–í–´–ï –ß–ê–¢–´ ==========
        function openGroupChat(groupId, groupName) {
            currentChatType = 'group'; currentChat = { id: groupId, name: groupName };
            document.getElementById('main-screen').style.display = 'none'; document.getElementById('chat-screen').style.display = 'flex'; document.getElementById('chat-title').innerText = groupName;
            socket.emit('join_group', groupId); loadGroupMessages(groupId);
            fetch(`/api/groups/${groupId}/members`).then(res => res.json()).then(members => { document.getElementById('chat-status').innerText = `—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${members.length}`; });
        }
        function loadGroupMessages(groupId) {
            fetch(`/api/messages/group/${groupId}`).then(res => res.json()).then(messages => { const container = document.getElementById('messages-container'); container.innerHTML = ''; messages.forEach(msg => renderMessage(msg)); container.scrollTop = container.scrollHeight; });
        }
        function closeChat() {
            document.getElementById('chat-screen').style.display = 'none'; document.getElementById('main-screen').style.display = 'flex'; currentChat = null; loadPrivateChats(); loadGroups();
        }

        // ========== –°–û–û–ë–©–ï–ù–ò–Ø ==========
        function sendMessage() {
            const input = document.getElementById('message-input'); const text = input.value.trim();
            if (text && currentChat && currentUser) {
                socket.emit('send_message', { chat_type: currentChatType, chat_id: currentChat.id, user_id: currentUser.id, text: text });
                input.value = '';
            }
        }
        function onMessageKeyPress(e) { if (e.key === 'Enter') sendMessage(); else { socket.emit('typing', { chat_type: currentChatType, chat_id: currentChat.id, user_id: currentUser.id, user_name: currentUser.name }); } }
        function renderMessage(message) {
            const container = document.getElementById('messages-container'); if (!container) return;
            const isMyMessage = message.user_id === currentUser?.id;
            const messageDiv = document.createElement('div'); messageDiv.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
            const messageDate = new Date(message.created_at); messageDate.setHours(messageDate.getHours() + 2);
            const time = messageDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            let content = '';
            if (message.voice_url) { content = `<div class="voice-message"><button class="voice-play-btn" onclick="playVoice('${message.voice_url}', this)">‚ñ∂</button><div class="voice-wave"><div class="voice-progress" style="width: 0%"></div><span class="voice-timer">0:00</span><span class="voice-duration">${message.duration || '0:05'}</span></div></div>`; }
            else if (message.photo_url) { content = `<div class="photo-message" onclick="openImageViewer('/uploads/photos/${message.photo_url}')"><img src="/uploads/photos/${message.photo_url}" alt="–§–æ—Ç–æ"></div>`; }
            else if (message.file_url) { content = `<div class="file-message"><span class="file-icon">üìé</span><div class="file-info"><div class="file-name">${message.file_name || '–§–∞–π–ª'}</div><div class="file-size">${formatFileSize(message.file_size)}</div></div><button class="download-btn" onclick="downloadFile('${message.file_url}', '${message.file_name}')">‚¨áÔ∏è</button></div>`; }
            else { let text = message.text || ''; const urlRegex = /(https?:\/\/[^\s]+)/g; text = text.replace(urlRegex, function(url) { return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: ${isMyMessage ? '#fff' : '#667eea'}; text-decoration: underline;">${url}</a>`; }); content = `<div class="message-text">${text}</div>`; }
            messageDiv.innerHTML = `<div class="message-bubble">${!isMyMessage && currentChatType === 'group' ? `<div class="message-sender">${message.user_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>` : ''}${content}<div class="message-time">${time}</div></div>`;
            container.appendChild(messageDiv);
        }

        // ========== –ì–û–õ–û–°–û–í–´–ï ==========
        async function toggleVoiceRecording() {
            const btn = document.getElementById('voiceRecordBtn');
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: { channelCount: 1, sampleRate: 48000, sampleSize: 16, echoCancellation: true, noiseSuppression: true, autoGainControl: true } });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus', audioBitsPerSecond: 64000 });
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); };
                    mediaRecorder.onstop = async () => { const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' }); await sendVoiceMessage(audioBlob); stream.getTracks().forEach(track => track.stop()); };
                    mediaRecorder.start(100); isRecording = true; btn.classList.add('recording'); btn.innerHTML = '‚èπ';
                } catch (err) { alert('–†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É!'); console.error(err); }
            } else { if (mediaRecorder && mediaRecorder.state !== 'inactive') { mediaRecorder.stop(); } isRecording = false; btn.classList.remove('recording'); btn.innerHTML = 'üé§'; }
        }
        async function sendVoiceMessage(audioBlob) {
            if (!currentChat || !currentUser) return;
            const formData = new FormData(); formData.append('voice', audioBlob); formData.append('chat_type', currentChatType); formData.append('chat_id', currentChat.id); formData.append('user_id', currentUser.id); formData.append('duration', '0:05');
            try { await fetch('/api/upload/voice', { method: 'POST', body: formData }); } catch (err) { console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–∞:', err); }
        }
        function playVoice(url, btn) {
            const audioUrl = `/uploads/voice/${url}`;
            if (audioElements[url]) { audioElements[url].pause(); delete audioElements[url]; btn.innerHTML = '‚ñ∂'; return; }
            const audio = new Audio(audioUrl); audioElements[url] = audio;
            const voiceMessage = btn.closest('.voice-message'); const wave = voiceMessage.querySelector('.voice-wave'); const progress = wave.querySelector('.voice-progress'); const timer = wave.querySelector('.voice-timer'); const duration = wave.querySelector('.voice-duration');
            btn.innerHTML = '‚è∏';
            audio.ontimeupdate = () => { const percent = (audio.currentTime / audio.duration) * 100; progress.style.width = `${percent}%`; const minutes = Math.floor(audio.currentTime / 60); const seconds = Math.floor(audio.currentTime % 60); timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`; };
            audio.onended = () => { btn.innerHTML = '‚ñ∂'; progress.style.width = '0%'; timer.textContent = '0:00'; delete audioElements[url]; };
            audio.play().catch(e => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
        }

        // ========== –§–û–¢–û –ò –§–ê–ô–õ–´ ==========
        function toggleAttachMenu() { const menu = document.getElementById('attachMenu'); menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; }
        function selectPhoto() { document.getElementById('attachMenu').style.display = 'none'; document.getElementById('photoInput').click(); }
        function selectFile() { document.getElementById('attachMenu').style.display = 'none'; document.getElementById('fileInput').click(); }
        document.getElementById('photoInput').onchange = function(e) {
            const file = e.target.files[0];
            if (file && currentChat && currentUser) {
                const formData = new FormData(); formData.append('photo', file); formData.append('chat_type', currentChatType); formData.append('chat_id', currentChat.id); formData.append('user_id', currentUser.id);
                fetch('/api/upload/photo', { method: 'POST', body: formData }).catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ:', err));
            } this.value = '';
        };
        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0];
            if (file && currentChat && currentUser) {
                const formData = new FormData(); formData.append('file', file); formData.append('chat_type', currentChatType); formData.append('chat_id', currentChat.id); formData.append('user_id', currentUser.id);
                fetch('/api/upload/file', { method: 'POST', body: formData }).catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞:', err));
            } this.value = '';
        };
        function openImageViewer(src) { document.getElementById('viewerImage').src = src; document.getElementById('imageViewer').classList.add('active'); }
        function closeImageViewer() { document.getElementById('imageViewer').classList.remove('active'); }
        function downloadFile(url, name) { const a = document.createElement('a'); a.href = `/uploads/files/${url}`; a.download = name || 'file'; a.click(); }
        function formatFileSize(bytes) { if (!bytes) return '0 B'; const kb = bytes / 1024; if (kb < 1024) return kb.toFixed(1) + ' KB'; const mb = kb / 1024; return mb.toFixed(1) + ' MB'; }
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); element.classList.add('active');
            document.getElementById('chats-list').classList.remove('active-list'); document.getElementById('groups-list').classList.remove('active-list'); document.getElementById('contacts-list').classList.remove('active-list'); document.getElementById('profile-screen').style.display = 'none'; document.getElementById('edit-profile-screen').style.display = 'none';
            document.getElementById(`${tabName}-list`).classList.add('active-list');
        }
        function logout() { localStorage.removeItem('teleRoomId'); localStorage.removeItem('teleRoomName'); document.getElementById('login-name').value = ''; location.reload(); }
        document.addEventListener('click', function(e) { const menu = document.getElementById('attachMenu'); const btn = document.querySelector('.attach-btn'); if (btn && !btn.contains(e.target) && menu && !menu.contains(e.target)) { menu.style.display = 'none'; } });

        // ========== –£–°–¢–ê–†–ï–í–®–ò–ï –§–£–ù–ö–¶–ò–ò (–î–õ–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò) ==========
        function editBio() { document.getElementById('bio-text').value = currentUser.bio || ''; document.getElementById('edit-bio-modal').classList.add('active'); }
        function hideEditBioModal() { document.getElementById('edit-bio-modal').classList.remove('active'); }
        function saveBio() { const bio = document.getElementById('bio-text').value.trim(); socket.emit('update_bio', { userId: currentUser.id, bio }); currentUser.bio = bio; document.getElementById('profile-bio').innerText = bio || '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'; hideEditBioModal(); }
        function editName() { const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:', currentUser.name); if (newName && newName.trim() && newName !== currentUser.name) { fetch('/api/user/update-name', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: currentUser.id, newName: newName.trim() }) }).then(res => res.json()).then(data => { if (data.error) alert('‚ùå ' + data.error); else { currentUser.name = data.name; document.getElementById('profile-name').innerText = data.name; document.getElementById('header-name').innerText = data.name; document.getElementById('header-avatar').innerText = data.name[0].toUpperCase(); document.getElementById('profile-avatar').innerText = data.name[0].toUpperCase(); localStorage.setItem('teleRoomName', data.name); alert('‚úÖ –ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ'); } }); } }
        function editUsername() { const newUsername = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —é–∑–µ—Ä–Ω–µ–π–º:', currentUser.phone); if (newUsername && newUsername.trim() && newUsername !== currentUser.phone) { fetch('/api/user/update-username', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: currentUser.id, newUsername: newUsername.trim() }) }).then(res => res.json()).then(data => { if (data.error) alert('‚ùå ' + data.error); else { currentUser.phone = data.username; document.getElementById('profile-username').innerText = '@' + data.username; localStorage.setItem('teleRoomId', data.username); alert('‚úÖ –Æ–∑–µ—Ä–Ω–µ–π–º –∏–∑–º–µ–Ω—ë–Ω'); } }); } }
    </script>
</body>
</html>
